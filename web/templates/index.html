<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instagram Downloader - Preview & Download</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .feature-card { transition: all 0.3s ease; }
        .feature-card:hover { transform: translateY(-4px); box-shadow: 0 12px 24px rgba(0,0,0,0.15); }
        .preview-item { transition: all 0.2s ease; cursor: pointer; }
        .preview-item.selected { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.3); }
        .preview-item:hover { transform: scale(1.02); }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.7); }
        .modal.active { display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 0; width: 95%; max-width: 1200px; max-height: 90vh; overflow-y: auto; border-radius: 12px; }
        .thumbnail-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        .selection-badge { position: absolute; top: 8px; right: 8px; background: #667eea; color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-50 to-pink-50">
    
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fab fa-instagram text-4xl"></i>
                    <div>
                        <h1 class="text-2xl font-bold">Instagram Downloader v2.0</h1>
                        <p class="text-sm opacity-90">Preview & Download with Smart Selection</p>
                    </div>
                </div>
            </div>
        </div>
    </header>
    
    <!-- Main Content -->
    <main class="container mx-auto px-4 py-12">
        
        <!-- Download Input Card -->
        <div class="max-w-4xl mx-auto mb-12">
            <div class="bg-white rounded-2xl shadow-2xl p-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center">
                    <i class="fas fa-search text-purple-600 mr-2"></i>
                    Enter Instagram Profile or URL
                </h2>
                
                <form id="preview-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-link mr-1"></i>
                            Username or Profile URL
                        </label>
                        <div class="relative">
                            <input type="text" 
                                   id="url-input" 
                                   placeholder="cristiano or https://instagram.com/cristiano/" 
                                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring focus:ring-purple-200 transition"
                                   required>
                            <i class="fas fa-search absolute right-4 top-4 text-gray-400"></i>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-info-circle mr-1"></i>
                            Get preview of posts before downloading
                        </p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Preview Items</label>
                        <select id="max-preview" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 transition">
                            <option value="25">25 items</option>
                            <option value="50">50 items</option>
                            <option value="100">100 items</option>
                            <option value="200">200 items</option>
                        </select>
                    </div>
                    
                    <button type="submit" 
                            class="w-full gradient-bg text-white font-bold py-4 rounded-lg shadow-lg hover:shadow-xl transition">
                        <i class="fas fa-eye mr-2"></i>
                        Show Preview
                    </button>
                </form>
                
                <!-- Loading State -->
                <div id="loading-preview" class="hidden text-center py-8">
                    <div class="loader mx-auto mb-4"></div>
                    <p class="text-gray-600">Fetching preview...</p>
                </div>
            </div>
        </div>
        
        <!-- My Downloads Section -->
        <div id="downloads" class="max-w-6xl mx-auto mb-12">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-folder-open text-purple-600 mr-2"></i>
                    My Downloads
                </h3>
                <button onclick="refreshDownloads()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Refresh
                </button>
            </div>
            <div id="downloads-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Dynamic content -->
            </div>
        </div>
        
    </main>
    
    <!-- Preview Modal -->
    <div id="preview-modal" class="modal">
        <div class="modal-content fade-in">
            <!-- Modal Header -->
            <div class="sticky top-0 bg-white border-b border-gray-200 p-6 z-10">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center space-x-4">
                        <img id="modal-profile-pic" src="" alt="" class="w-16 h-16 rounded-full border-2 border-purple-500">
                        <div>
                            <h3 id="modal-username" class="text-2xl font-bold text-gray-800"></h3>
                            <p id="modal-bio" class="text-sm text-gray-600"></p>
                            <div class="flex items-center space-x-4 mt-2 text-sm text-gray-500">
                                <span><i class="fas fa-images mr-1"></i><span id="modal-total-posts">0</span> posts</span>
                                <span><i class="fas fa-users mr-1"></i><span id="modal-followers">0</span> followers</span>
                            </div>
                        </div>
                    </div>
                    <button onclick="closePreviewModal()" class="text-gray-500 hover:text-gray-700 text-3xl">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <!-- Selection Controls -->
                <div class="flex items-center justify-between bg-purple-50 p-4 rounded-lg">
                    <div class="flex items-center space-x-4">
                        <button onclick="selectAll()" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-sm">
                            <i class="fas fa-check-double mr-1"></i> Select All
                        </button>
                        <button onclick="deselectAll()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition text-sm">
                            <i class="fas fa-times mr-1"></i> Deselect All
                        </button>
                        <span class="text-sm font-semibold text-gray-700">
                            <span id="selected-count">0</span> selected
                        </span>
                    </div>
                    <button onclick="downloadSelected()" id="download-selected-btn" 
                            class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold shadow-lg disabled:opacity-50 disabled:cursor-not-allowed"
                            disabled>
                        <i class="fas fa-download mr-2"></i>
                        Download Selected
                    </button>
                </div>
            </div>
            
            <!-- Preview Grid -->
            <div id="preview-grid" class="p-6 thumbnail-grid">
                <!-- Dynamic content -->
            </div>
            
            <!-- Loading More -->
            <div id="preview-loading" class="hidden p-6 text-center">
                <div class="loader mx-auto"></div>
                <p class="text-gray-600 mt-2">Loading more...</p>
            </div>
        </div>
    </div>
    
    <!-- Active Downloads Section -->
    <div id="active-downloads-section" class="fixed bottom-4 right-4 w-96 hidden">
        <div class="bg-white rounded-xl shadow-2xl">
            <div class="p-4 cursor-pointer" onclick="toggleActiveDownloads()">
                <h4 class="font-bold text-gray-800 flex items-center justify-between">
                    <span><i class="fas fa-spinner fa-pulse text-purple-600 mr-2"></i>Active Downloads</span>
                    <div class="flex items-center space-x-2">
                        <button onclick="event.stopPropagation(); minimizeActiveDownloads()" class="text-gray-400 hover:text-gray-600">
                            <i id="minimize-icon" class="fas fa-chevron-down"></i>
                        </button>
                        <button onclick="event.stopPropagation(); hideActiveDownloads()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </h4>
            </div>
            <div id="active-downloads-content" class="px-4 pb-4">
                <div id="active-downloads-list" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>
    
    <script>
        let previewData = null;
        let selectedShortcodes = new Set();
        let activeJobs = new Set();
        
        // Preview form submission
        document.getElementById('preview-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const url = document.getElementById('url-input').value.trim();
            const maxPreview = parseInt(document.getElementById('max-preview').value);
            
            if (!url) {
                showToast('Please enter a username or URL', 'error');
                return;
            }
            
            // Show loading
            document.getElementById('loading-preview').classList.remove('hidden');
            document.getElementById('preview-form').classList.add('hidden');
            
            try {
                const response = await fetch('/api/preview', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        url: url,
                        max_items: maxPreview
                    })
                });
                
                const data = await response.json();
                
                console.log('Preview response:', data);  // Debug
                
                if (response.ok && data.success) {
                    if (!data.preview_items || data.preview_items.length === 0) {
                        showToast('No posts found. Profile may be private or empty.', 'error');
                        document.getElementById('preview-form').classList.remove('hidden');
                        return;
                    }
                    previewData = data;
                    selectedShortcodes.clear();
                    showPreviewModal(data);
                } else {
                    // Show helpful error message
                    const errorMsg = data.error || 'Failed to fetch preview';
                    
                    if (data.needs_login) {
                        showToast('‚ö†Ô∏è Instagram giri≈üi gerekli! L√ºtfen terminal\'de "python src/main.py --login" ile giri≈ü yapƒ±n.', 'error');
                    } else if (data.is_private) {
                        showToast('üîí ' + errorMsg, 'error');
                    } else {
                        showToast(errorMsg, 'error');
                    }
                    
                    document.getElementById('preview-form').classList.remove('hidden');
                }
                
            } catch (error) {
                console.error('Preview error:', error);  // Debug
                showToast('Network error: ' + error.message, 'error');
                document.getElementById('preview-form').classList.remove('hidden');
            } finally {
                document.getElementById('loading-preview').classList.add('hidden');
            }
        });
        
        function showPreviewModal(data) {
            // Populate modal header
            const profilePic = document.getElementById('modal-profile-pic');
            profilePic.src = data.profile_pic_url;
            profilePic.onerror = function() {
                this.src = 'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ccircle fill=%22%23667eea%22 cx=%2250%22 cy=%2250%22 r=%2250%22/%3E%3Ctext fill=%22white%22 font-family=%22Arial%22 font-size=%2240%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3E' + data.username.charAt(0).toUpperCase() + '%3C/text%3E%3C/svg%3E';
            };
            document.getElementById('modal-username').textContent = data.username;
            document.getElementById('modal-bio').textContent = data.bio || 'No bio';
            document.getElementById('modal-total-posts').textContent = data.total_posts;
            document.getElementById('modal-followers').textContent = data.followers.toLocaleString();
            
            // Populate preview grid
            const grid = document.getElementById('preview-grid');
            grid.innerHTML = '';
            
            data.preview_items.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'preview-item relative bg-gray-100 rounded-lg overflow-hidden border-2 border-transparent';
                div.dataset.shortcode = item.shortcode;
                div.onclick = () => toggleSelection(item.shortcode);
                
                div.innerHTML = `
                    <div class="relative aspect-square bg-gray-200 flex items-center justify-center">
                        <img src="${item.thumbnail_url}" 
                             alt="Post thumbnail" 
                             class="w-full h-full object-cover"
                             onerror="this.onerror=null; this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 400 400%22%3E%3Crect fill=%22%23e5e7eb%22 width=%22400%22 height=%22400%22/%3E%3Ctext fill=%22%239ca3af%22 font-family=%22Arial%22 font-size=%2220%22 x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22%3E${item.is_video ? 'üìπ Video' : 'üì∑ Photo'}%3C/text%3E%3C/svg%3E'; this.classList.add('opacity-50');">
                        ${item.is_video ? '<div class="absolute top-2 left-2 bg-black bg-opacity-60 rounded-full p-2"><i class="fas fa-play text-white text-lg"></i></div>' : ''}
                        ${item.is_carousel ? '<div class="absolute top-2 right-2 bg-black bg-opacity-60 rounded-full p-2"><i class="fas fa-clone text-white text-sm"></i></div>' : ''}
                        <div class="selection-badge hidden">
                            <i class="fas fa-check"></i>
                        </div>
                    </div>
                    <div class="p-2">
                        <div class="flex items-center justify-between text-xs text-gray-600">
                            <span><i class="fas fa-heart mr-1 text-red-500"></i>${formatNumber(item.likes)}</span>
                            <span><i class="fas fa-comment mr-1 text-blue-500"></i>${formatNumber(item.comments)}</span>
                        </div>
                        ${item.caption ? `<p class="text-xs text-gray-500 mt-1 truncate" title="${item.caption.replace(/"/g, '&quot;')}">${item.caption.substring(0, 50)}...</p>` : ''}
                    </div>
                `;
                
                grid.appendChild(div);
            });
            
            // Show modal
            document.getElementById('preview-modal').classList.add('active');
            document.getElementById('preview-form').classList.remove('hidden');
            updateSelectionCount();
        }
        
        function closePreviewModal() {
            document.getElementById('preview-modal').classList.remove('active');
            selectedShortcodes.clear();
        }
        
        function toggleSelection(shortcode) {
            if (selectedShortcodes.has(shortcode)) {
                selectedShortcodes.delete(shortcode);
            } else {
                selectedShortcodes.add(shortcode);
            }
            
            // Update UI
            const item = document.querySelector(`[data-shortcode="${shortcode}"]`);
            if (item) {
                const badge = item.querySelector('.selection-badge');
                if (selectedShortcodes.has(shortcode)) {
                    item.classList.add('selected');
                    badge.classList.remove('hidden');
                } else {
                    item.classList.remove('selected');
                    badge.classList.add('hidden');
                }
            }
            
            updateSelectionCount();
        }
        
        function selectAll() {
            if (!previewData) return;
            
            previewData.preview_items.forEach(item => {
                selectedShortcodes.add(item.shortcode);
                const elem = document.querySelector(`[data-shortcode="${item.shortcode}"]`);
                if (elem) {
                    elem.classList.add('selected');
                    elem.querySelector('.selection-badge').classList.remove('hidden');
                }
            });
            
            updateSelectionCount();
        }
        
        function deselectAll() {
            selectedShortcodes.clear();
            
            document.querySelectorAll('.preview-item').forEach(item => {
                item.classList.remove('selected');
                item.querySelector('.selection-badge').classList.add('hidden');
            });
            
            updateSelectionCount();
        }
        
        function updateSelectionCount() {
            const count = selectedShortcodes.size;
            document.getElementById('selected-count').textContent = count;
            document.getElementById('download-selected-btn').disabled = count === 0;
        }
        
        async function downloadSelected() {
            if (selectedShortcodes.size === 0 || !previewData) return;
            
            const shortcodeArray = Array.from(selectedShortcodes);
            
            try {
                const response = await fetch('/api/download/selected', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        username: previewData.username,
                        shortcodes: shortcodeArray
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    showToast(`Downloading ${shortcodeArray.length} items...`, 'success');
                    closePreviewModal();
                    
                    // Track job
                    activeJobs.add(data.job_id);
                    showActiveDownloads();
                    pollJobStatus(data.job_id);
                } else {
                    showToast(data.error || 'Download failed', 'error');
                }
                
            } catch (error) {
                showToast('Network error: ' + error.message, 'error');
            }
        }
        
        async function pollJobStatus(jobId) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/job/${jobId}`);
                    const job = await response.json();
                    
                    updateActiveDownload(job);
                    
                    if (job.status === 'completed' || job.status === 'failed') {
                        clearInterval(interval);
                        activeJobs.delete(jobId);
                        
                        if (activeJobs.size === 0) {
                            setTimeout(hideActiveDownloads, 3000);
                        }
                        
                        if (job.status === 'completed') {
                            refreshDownloads();
                            const itemsText = job.downloaded_items > 0 ? `${job.downloaded_items} items` : 'content';
                            showToast(`‚úÖ Downloaded ${itemsText} successfully!`, 'success');
                            
                            // Show instruction after 2 seconds
                            setTimeout(() => {
                                showToast('üì¶ Scroll down to "My Downloads" and click "Download ZIP" button', 'info');
                            }, 2000);
                        } else {
                            showToast('Download failed: ' + job.error_message, 'error');
                        }
                    }
                } catch (error) {
                    clearInterval(interval);
                }
            }, 1000);
        }
        
        function updateActiveDownload(job) {
            const container = document.getElementById('active-downloads-list');
            let card = document.getElementById(`job-${job.job_id}`);
            
            if (!card) {
                card = document.createElement('div');
                card.id = `job-${job.job_id}`;
                card.className = 'bg-purple-50 rounded-lg p-3';
                container.appendChild(card);
            }
            
            const progress = job.progress || 0;
            
            card.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <span class="font-semibold text-sm text-gray-800">${job.target}</span>
                    <span class="text-sm font-bold text-purple-600">${progress}%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2 mb-2">
                    <div class="bg-purple-600 h-2 rounded-full transition-all" style="width: ${progress}%"></div>
                </div>
                <div class="text-xs text-gray-600">${job.downloaded_items} / ${job.total_items} items</div>
            `;
        }
        
        function showActiveDownloads() {
            document.getElementById('active-downloads-section').classList.remove('hidden');
        }
        
        function hideActiveDownloads() {
            document.getElementById('active-downloads-section').classList.add('hidden');
        }
        
        async function refreshDownloads() {
            try {
                console.log('üîÑ Refreshing downloads list...');
                const response = await fetch('/api/profiles/list');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const profiles = await response.json();
                console.log('‚úÖ API Response:', profiles);
                
                // Debug: Log each profile's counts
                profiles.forEach(p => {
                    console.log(`üìä ${p.username}: ${p.photo_count} photos, ${p.video_count} videos (Total: ${p.total_count})`);
                });
                
                const container = document.getElementById('downloads-list');
                
                if (profiles.length === 0) {
                    container.innerHTML = `
                        <div class="col-span-full text-center py-12 text-gray-500">
                            <i class="fas fa-folder-open text-6xl mb-4 opacity-50"></i>
                            <p class="text-lg">No downloads yet</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = profiles.map(profile => `
                    <div class="bg-white rounded-xl shadow-lg p-6 hover:shadow-xl transition">
                        <div class="flex items-center space-x-3 mb-4">
                            <i class="fab fa-instagram text-purple-600 text-3xl"></i>
                            <div class="flex-1">
                                <h4 class="font-bold text-gray-800">${profile.username}</h4>
                                <p class="text-xs text-gray-500">${profile.metadata.download_timestamp ? new Date(profile.metadata.download_timestamp).toLocaleDateString() : ''}</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="text-center p-3 bg-blue-50 rounded-lg">
                                <i class="fas fa-image text-blue-600 mb-1"></i>
                                <div class="text-2xl font-bold text-blue-600">${profile.photo_count}</div>
                                <div class="text-xs text-gray-600">Photos</div>
                            </div>
                            <div class="text-center p-3 bg-red-50 rounded-lg">
                                <i class="fas fa-video text-red-600 mb-1"></i>
                                <div class="text-2xl font-bold text-red-600">${profile.video_count}</div>
                                <div class="text-xs text-gray-600">Videos</div>
                            </div>
                        </div>
                        
                        <button onclick="downloadZip('${profile.username}')" 
                                class="w-full gradient-bg text-white font-semibold py-3 rounded-lg hover:shadow-lg transition transform hover:scale-105 animate-pulse">
                            <i class="fas fa-download mr-2"></i>
                            Download ZIP
                        </button>
                    </div>
                `).join('');
                
                showToast('Downloads refreshed!', 'success');
                console.log('Downloads list updated successfully');
                
            } catch (error) {
                console.error('Refresh error:', error);
                showToast('Failed to refresh: ' + error.message, 'error');
            }
        }
        
        function downloadZip(folder) {
            console.log(`üì¶ Downloading ZIP for: ${folder}`);
            console.log(`üìç API endpoint: /api/download/zip/${folder}`);
            window.location.href = `/api/download/zip/${folder}`;
            showToast('Preparing download...', 'info');
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `px-6 py-3 rounded-lg shadow-lg text-white fade-in ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 
                'bg-blue-500'
            }`;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} mr-2"></i>${message}`;
            container.appendChild(toast);
            
            // Keep info messages longer (5 seconds), others 3 seconds
            const duration = type === 'info' ? 5000 : 3000;
            setTimeout(() => toast.remove(), duration);
        }
        
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num;
        }
        
        // Active Downloads minimize/maximize
        let isMinimized = false;
        
        function minimizeActiveDownloads() {
            const content = document.getElementById('active-downloads-content');
            const icon = document.getElementById('minimize-icon');
            
            if (isMinimized) {
                content.style.display = 'block';
                icon.className = 'fas fa-chevron-down';
                isMinimized = false;
            } else {
                content.style.display = 'none';
                icon.className = 'fas fa-chevron-up';
                isMinimized = true;
            }
        }
        
        function toggleActiveDownloads() {
            // Click on header to toggle
            if (!isMinimized) {
                minimizeActiveDownloads();
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Page loaded, initializing...');
            refreshDownloads();
            console.log('‚úÖ Initial refresh triggered');
        });
        
        // Refresh every 30 seconds
        setInterval(refreshDownloads, 30000);
        
        // Close modal on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') closePreviewModal();
        });
    </script>
</body>
</html>
